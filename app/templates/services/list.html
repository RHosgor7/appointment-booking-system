{% extends "base.html" %}

{% block content %}
<!--begin::Content container-->
<div id="kt_app_content_container" class="app-container container-xxl">
	<!--begin::Card-->
	<div class="card">
		<!--begin::Card header-->
		<div class="card-header border-0 pt-6">
			<!--begin::Card title-->
			<div class="card-title">
				<h2 class="fw-bold">Services</h2>
			</div>
			<!--end::Card title-->
			<!--begin::Card toolbar-->
			<div class="card-toolbar">
				<!--begin::Add service-->
				<a href="/services/create" class="btn btn-primary">
					<i class="ki-duotone ki-plus fs-2"></i>Add Service
				</a>
				<!--end::Add service-->
			</div>
			<!--end::Card toolbar-->
		</div>
		<!--end::Card header-->
		<!--begin::Card body-->
		<div class="card-body pt-0">
			<!--begin::Table-->
			<table class="table align-middle table-row-dashed fs-6 gy-5" id="kt_services_table">
				<thead>
					<tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
						<th class="min-w-80px">ID</th>
						<th class="min-w-125px">Service Name</th>
						<th class="min-w-125px">Description</th>
						<th class="min-w-100px">Duration</th>
						<th class="min-w-100px">Price</th>
						<th class="min-w-100px">Status</th>
						<th class="min-w-125px">Created Date</th>
						<th class="text-end min-w-70px">Actions</th>
					</tr>
				</thead>
				<tbody class="fw-semibold text-gray-600" id="kt_services_table_body">
					<!-- Data will be loaded here via JavaScript -->
					<tr id="kt_services_table_loading">
						<td colspan="8" class="text-center py-10">
							<div class="spinner-border text-primary" role="status">
								<span class="visually-hidden">Loading...</span>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
			<!--end::Table-->
		</div>
		<!--end::Card body-->
	</div>
	<!--end::Card-->
	<!--begin::Table Info (outside card)-->
	<div class="d-flex align-items-center justify-content-between flex-wrap mt-5">
		<div class="text-gray-600 fw-semibold fs-6" id="kt_services_table_info">
			<!-- DataTable info will be displayed here -->
		</div>
	</div>
	<!--end::Table Info-->
</div>
<!--end::Content container-->
{% endblock %}

{% block scripts %}
<script>
	"use strict";

	// Token kontrol√º
	const token = localStorage.getItem('access_token');
	if (!token) {
		window.location.href = '/login';
	}

	// API base URL
	const API_BASE = '/api/services';

	// Race condition guard: AbortController for fetch requests
	let currentAbortController = null;
	let currentRequestId = 0;

	// DataTable instance
	let datatable = null;
	let table = null;
	let currentPageLength = 10; // Store current page length to preserve select2 value

	// Escape HTML to prevent XSS - null/number safe
	function escapeHtml(text) {
		// Convert to string safely (handles null, undefined, numbers)
		const str = String(text || '');
		if (!str) return '';
		const map = {
			'&': '&amp;',
			'<': '&lt;',
			'>': '&gt;',
			'"': '&quot;',
			"'": '&#039;'
		};
		return str.replace(/[&<>"']/g, m => map[m]);
	}

	// Load services function with race condition protection
	async function loadServices() {
		// Abort previous request if still pending
		if (currentAbortController) {
			currentAbortController.abort();
		}

		// Create new AbortController and request ID for this request
		currentAbortController = new AbortController();
		const signal = currentAbortController.signal;
		const requestId = ++currentRequestId;

		const tbody = document.getElementById('kt_services_table_body');
		const loadingRow = document.getElementById('kt_services_table_loading');
		
		if (!tbody) {
			console.warn('kt_services_table_body element not found');
			return;
		}

		try {
			const response = await fetch(API_BASE, {
				method: 'GET',
				headers: {
					'Authorization': `Bearer ${token}`,
					'Content-Type': 'application/json'
				},
				signal: signal
			});

			// Check if request was aborted
			if (signal.aborted) {
				return;
			}

			if (!response.ok) {
				if (response.status === 401) {
					localStorage.removeItem('access_token');
					window.location.href = '/login';
					return;
				}
				throw new Error(`HTTP error! status: ${response.status}`);
			}

			const services = await response.json();

			// Check again if request was aborted or if this is not the latest request
			if (signal.aborted || requestId !== currentRequestId) {
				console.log('Request aborted or superseded, ignoring response');
				return;
			}
			
			// Remove loading row
			if (loadingRow) {
				loadingRow.remove();
			}

			// Destroy DataTable BEFORE populating table (if it exists)
			// Preserve current page length before destroying
			if (datatable) {
				try {
					const pageInfo = datatable.page.info();
					currentPageLength = pageInfo.length; // Get current page length
				} catch (e) {
					// If page info is not available, keep current value
				}
				datatable.destroy();
				datatable = null;
			}

			// Clear tbody AFTER DataTable destroy (DataTable destroy may leave rows)
			tbody.innerHTML = '';

			// Final check before rendering (double-check race condition)
			if (signal.aborted || requestId !== currentRequestId) {
				console.log('Request aborted before rendering, ignoring response');
				return;
			}

			if (services.length === 0) {
				// Clear tbody completely - let DataTables handle empty state
				tbody.innerHTML = '';
				// Initialize DataTable with empty data
				if (typeof $ !== 'undefined' && $.fn.DataTable && table) {
					datatable = $(table).DataTable({
						"info": false,
						"order": [],
						"pageLength": currentPageLength,
						"data": [], // Empty data array
						"columns": [
							null, // ID
							null, // Service Name
							null, // Description
							null, // Duration
							null, // Price
							null, // Status
							null, // Created Date
							{"orderable": false} // Actions
						],
						"language": {
							"emptyTable": "No services found",
							"zeroRecords": "No matching services found"
						}
					});
					datatable.on('draw', function() {
						updateTableInfo();
					});
					// Listen for page length change to preserve it
					datatable.on('length.dt', function(e, settings, len) {
						currentPageLength = len;
					});
					updateTableInfo();
				}
				// Reinitialize Metronic menus after render
				if (typeof KTMenu !== 'undefined') {
					KTMenu.init();
				}
				return;
			}

			// Populate table - prevent duplicate IDs
			const renderedIds = new Set();
			services.forEach(service => {
				// Skip if this service ID was already rendered (duplicate prevention)
				if (renderedIds.has(service.id)) {
					console.warn(`Duplicate service ID detected: ${service.id}, skipping`);
					return;
				}
				renderedIds.add(service.id);

				// Final check before rendering this row
				if (signal.aborted || requestId !== currentRequestId) {
					console.log('Request aborted during row rendering, stopping');
					return;
				}

				const row = document.createElement('tr');
				const createdDate = new Date(service.created_at);
				const formattedDate = createdDate.toLocaleDateString('en-US', {
					year: 'numeric',
					month: 'short',
					day: 'numeric',
					hour: '2-digit',
					minute: '2-digit'
				});

				const statusBadge = service.is_active 
					? '<span class="badge badge-light-success">Active</span>'
					: '<span class="badge badge-light-danger">Inactive</span>';

				row.innerHTML = `
					<td>
						<div class="text-gray-800 fw-bold">#${escapeHtml(service.id)}</div>
					</td>
					<td>${escapeHtml(service.name)}</td>
					<td>${escapeHtml(service.description || '-')}</td>
					<td>${service.duration_minutes} min</td>
					<td>$${parseFloat(service.price).toFixed(2)}</td>
					<td>${statusBadge}</td>
					<td>${formattedDate}</td>
					<td class="text-end">
						<a href="#" class="btn btn-sm btn-light btn-flex btn-center btn-active-light-primary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
							Actions 
							<i class="ki-duotone ki-down fs-5 ms-1">
								<span class="path1"></span>
								<span class="path2"></span>
							</i>
						</a>
						<!--begin::Menu-->
						<div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4" data-kt-menu="true">
							<!--begin::Menu item-->
							<div class="menu-item px-3">
								<a href="/services/${service.id}/edit" class="menu-link px-3">Edit</a>
							</div>
							<!--end::Menu item-->
						</div>
						<!--end::Menu-->
					</td>
				`;
				tbody.appendChild(row);
			});

			// Final check before initializing DataTable
			if (signal.aborted || requestId !== currentRequestId) {
				console.log('Request aborted before DataTable init, ignoring');
				return;
			}

			// Initialize DataTable AFTER populating table
			if (typeof $ !== 'undefined' && $.fn.DataTable) {
				datatable = $(table).DataTable({
					"info": false, // We'll use custom info display
					"order": [],
					"pageLength": currentPageLength, // Use preserved page length
					"columns": [
						null, // ID
						null, // Service Name
						null, // Description
						null, // Duration
						null, // Price
						null, // Status
						null, // Created Date
						{"orderable": false} // Actions
					],
					"language": {
						"emptyTable": "No services found",
						"zeroRecords": "No matching services found"
					}
				});

				// Update custom info display on draw and page change
				datatable.on('draw', function() {
					updateTableInfo();
				});

				// Listen for page length change to preserve it
				datatable.on('length.dt', function(e, settings, len) {
					currentPageLength = len;
				});

				// Initial update
				updateTableInfo();
			}

			// Reinitialize Metronic menus after table render is complete
			if (typeof KTMenu !== 'undefined') {
				KTMenu.init();
				// Also try createInstances if available
				if (typeof KTMenu.createInstances === 'function') {
					KTMenu.createInstances();
				}
			}

			// Log successful render for debugging
			console.log(`Services rendered: ${services.length} services (request ID: ${requestId})`);

		} catch (error) {
			// Ignore abort errors
			if (error.name === 'AbortError') {
				return;
			}
			console.error('Error loading services:', error);
			if (loadingRow) {
				loadingRow.innerHTML = `
					<td colspan="8" class="text-center py-10">
						<div class="text-danger">Error loading services. Please try again.</div>
					</td>
				`;
			}
		} finally {
			// Clear abort controller if this was the current request
			if (currentAbortController && currentAbortController.signal === signal) {
				currentAbortController = null;
			}
		}
	}

	// Update table info display
	function updateTableInfo() {
		if (!datatable) return;
		
		const info = datatable.page.info();
		const infoElement = document.getElementById('kt_services_table_info');
		
		if (infoElement) {
			const start = info.start + 1;
			const end = info.end;
			const total = info.recordsTotal;
			const filtered = info.recordsDisplay;
			
			if (filtered === 0) {
				infoElement.textContent = 'No services found';
			} else {
				infoElement.textContent = `Showing ${start} to ${end} of ${filtered} entries${filtered !== total ? ` (filtered from ${total} total entries)` : ''}`;
			}
		}
	}

	// Configure toastr global settings
	if (typeof toastr !== 'undefined') {
		toastr.options = {
			"closeButton": true,
			"debug": false,
			"newestOnTop": true,
			"progressBar": false,
			"positionClass": "toast-top-right",
			"preventDuplicates": false,
			"onclick": null,
			"showDuration": "300",
			"hideDuration": "1000",
			"timeOut": "5000",
			"extendedTimeOut": "1000",
			"showEasing": "swing",
			"hideEasing": "linear",
			"showMethod": "fadeIn",
			"hideMethod": "fadeOut"
		};
	}

	// Load services on page load
	document.addEventListener('DOMContentLoaded', function() {
		// Get table element
		table = document.getElementById('kt_services_table');
		if (!table) {
			console.error('kt_services_table element not found');
			return;
		}

		loadServices();
	});
</script>
{% endblock %}
