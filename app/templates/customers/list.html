{% extends "base.html" %}

{% block content %}
<!--begin::Content container-->
<div id="kt_app_content_container" class="app-container container-xxl">
	<!--begin::Card-->
	<div class="card">
		<!--begin::Card header-->
		<div class="card-header border-0 pt-6">
			<!--begin::Card title-->
			<div class="card-title">
				<!--begin::Search-->
				<div class="d-flex align-items-center position-relative my-1">
					<i class="ki-duotone ki-magnifier fs-3 position-absolute ms-5">
						<span class="path1"></span>
						<span class="path2"></span>
					</i>
					<input type="text" id="kt_customer_table_search" class="form-control form-control-solid w-250px ps-12" placeholder="Search Customers" />
				</div>
				<!--end::Search-->
			</div>
			<!--end::Card title-->
			<!--begin::Card toolbar-->
			<div class="card-toolbar flex-row-fluid justify-content-end gap-5">
				<!--begin::Filter Menu-->
				<div class="m-0">
					<!--begin::Menu toggle-->
					<a href="#" class="btn btn-flex btn-secondary fw-bold" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
						<i class="ki-duotone ki-filter fs-6 text-muted me-1">
							<span class="path1"></span>
							<span class="path2"></span>
						</i>Filter</a>
					<!--end::Menu toggle-->
					<!--begin::Menu-->
					<div class="menu menu-sub menu-sub-dropdown w-300px w-md-350px" data-kt-menu="true" id="kt_customer_filter_menu">
						<!--begin::Header-->
						<div class="px-7 py-5">
							<div class="fs-5 text-gray-900 fw-bold">Filter Options</div>
						</div>
						<!--end::Header-->
						<!--begin::Menu separator-->
						<div class="separator border-gray-200"></div>
						<!--end::Menu separator-->
						<!--begin::Form-->
						<div class="px-7 py-5">
							<!--begin::Input group - Name-->
							<div class="mb-10">
								<label class="form-label fw-semibold">Name:</label>
								<input type="text" class="form-control form-control-solid" id="filter_name" placeholder="Enter name" />
							</div>
							<!--end::Input group-->
							<!--begin::Input group - Email-->
							<div class="mb-10">
								<label class="form-label fw-semibold">Email:</label>
								<input type="text" class="form-control form-control-solid" id="filter_email" placeholder="Enter email" />
							</div>
							<!--end::Input group-->
							<!--begin::Input group - Phone-->
							<div class="mb-10">
								<label class="form-label fw-semibold">Phone:</label>
								<input type="text" class="form-control form-control-solid" id="filter_phone" placeholder="Enter phone" />
							</div>
							<!--end::Input group-->
							<!--begin::Actions-->
							<div class="d-flex justify-content-end">
								<button type="button" class="btn btn-sm btn-light btn-active-light-primary me-2" id="btn_reset_filters" data-kt-menu-dismiss="true">Reset</button>
								<button type="button" class="btn btn-sm btn-primary" id="btn_apply_filters" data-kt-menu-dismiss="true">Apply</button>
							</div>
							<!--end::Actions-->
						</div>
						<!--end::Form-->
					</div>
					<!--end::Menu-->
				</div>
				<!--end::Filter Menu-->
				<!--begin::Add customer-->
				<a href="/customers/create" class="btn btn-primary">
					<i class="ki-duotone ki-plus fs-2"></i>Add Customer
				</a>
				<!--end::Add customer-->
			</div>
			<!--end::Card toolbar-->
		</div>
		<!--end::Card header-->
		<!--begin::Card body-->
		<div class="card-body pt-0">
			<!--begin::Table-->
			<table class="table align-middle table-row-dashed fs-6 gy-5" id="kt_customers_table">
				<thead>
					<tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
						<th class="min-w-80px">ID</th>
						<th class="min-w-125px">Customer Name</th>
						<th class="min-w-125px">Email</th>
						<th class="min-w-125px">Phone</th>
						<th class="min-w-125px">Created Date</th>
						<th class="text-end min-w-70px">Actions</th>
					</tr>
				</thead>
				<tbody class="fw-semibold text-gray-600" id="kt_customers_table_body">
					<!-- Data will be loaded here via JavaScript -->
					<tr id="kt_customers_table_loading">
						<td colspan="6" class="text-center py-10">
							<div class="spinner-border text-primary" role="status">
								<span class="visually-hidden">Loading...</span>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
			<!--end::Table-->
		</div>
		<!--end::Card body-->
	</div>
	<!--end::Card-->
	<!--begin::Table Info (outside card)-->
	<div class="d-flex align-items-center justify-content-between flex-wrap mt-5">
		<div class="text-gray-600 fw-semibold fs-6" id="kt_customers_table_info">
			<!-- DataTable info will be displayed here -->
		</div>
	</div>
	<!--end::Table Info-->
</div>
<!--end::Content container-->

<!--begin::Modal - Add Customer-->
<div class="modal fade" id="kt_modal_add_customer" tabindex="-1" aria-hidden="true">
	<!--begin::Modal dialog-->
	<div class="modal-dialog modal-dialog-centered mw-650px">
		<!--begin::Modal content-->
		<div class="modal-content">
			<!--begin::Form-->
			<form class="form" id="kt_modal_add_customer_form">
				<!--begin::Modal header-->
				<div class="modal-header">
					<!--begin::Modal title-->
					<h2 class="fw-bold">Add Customer</h2>
					<!--end::Modal title-->
					<!--begin::Close-->
					<div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
						<i class="ki-duotone ki-cross fs-1">
							<span class="path1"></span>
							<span class="path2"></span>
						</i>
					</div>
					<!--end::Close-->
				</div>
				<!--end::Modal header-->
				<!--begin::Modal body-->
				<div class="modal-body py-10 px-lg-17">
					<!--begin::Input group-->
					<div class="mb-10">
						<label class="form-label required">Full Name</label>
						<input type="text" class="form-control form-control-solid" name="full_name" placeholder="Enter full name" required />
					</div>
					<!--end::Input group-->
					<!--begin::Input group-->
					<div class="mb-10">
						<label class="form-label required">Email</label>
						<input type="email" class="form-control form-control-solid" name="email" placeholder="Enter email" required />
					</div>
					<!--end::Input group-->
					<!--begin::Input group-->
					<div class="mb-10">
						<label class="form-label required">Phone</label>
						<input type="tel" class="form-control form-control-solid" name="phone" placeholder="Enter phone number" required />
					</div>
					<!--end::Input group-->
				</div>
				<!--end::Modal body-->
				<!--begin::Modal footer-->
				<div class="modal-footer">
					<button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary" id="kt_modal_add_customer_submit">
						<span class="indicator-label">Add Customer</span>
						<span class="indicator-progress">Please wait...
							<span class="spinner-border spinner-border-sm align-middle ms-2"></span>
						</span>
					</button>
				</div>
				<!--end::Modal footer-->
			</form>
			<!--end::Form-->
		</div>
		<!--end::Modal content-->
	</div>
	<!--end::Modal dialog-->
</div>
<!--end::Modal - Add Customer-->
{% endblock %}

{% block scripts %}
<script>
	"use strict";

	// Token kontrolü
	const token = localStorage.getItem('access_token');
	if (!token) {
		window.location.href = '/login';
	}

	// API base URL
	const API_BASE = '/api/customers';

	// Filter state
	let currentFilters = {
		name: null,
		email: null,
		phone: null
	};

	// Race condition guard: AbortController for fetch requests
	let currentAbortController = null;
	let currentRequestId = 0;

	// DataTable instance
	let datatable = null;
	let table = null;
	let currentPageLength = 10; // Store current page length to preserve select2 value

	// Escape HTML to prevent XSS - null/number safe
	function escapeHtml(text) {
		// Convert to string safely (handles null, undefined, numbers)
		const str = String(text || '');
		if (!str) return '';
		const map = {
			'&': '&amp;',
			'<': '&lt;',
			'>': '&gt;',
			'"': '&quot;',
			"'": '&#039;'
		};
		return str.replace(/[&<>"']/g, m => map[m]);
	}

	// Load customers function with race condition protection
	async function loadCustomers() {
		// Abort previous request if still pending
		if (currentAbortController) {
			currentAbortController.abort();
		}

		// Create new AbortController and request ID for this request
		currentAbortController = new AbortController();
		const signal = currentAbortController.signal;
		const requestId = ++currentRequestId;

		const tbody = document.getElementById('kt_customers_table_body');
		const loadingRow = document.getElementById('kt_customers_table_loading');
		
		if (!tbody) {
			console.warn('kt_customers_table_body element not found');
			return;
		}

		try {
			// Build query parameters with filters
			const params = new URLSearchParams();
			
			// Filter parameters
			if (currentFilters.name && currentFilters.name.trim()) {
				params.append('name', currentFilters.name.trim());
			}
			if (currentFilters.email && currentFilters.email.trim()) {
				params.append('email', currentFilters.email.trim());
			}
			if (currentFilters.phone && currentFilters.phone.trim()) {
				params.append('phone', currentFilters.phone.trim());
			}
			
			const queryString = params.toString();
			const url = queryString ? `${API_BASE}?${queryString}` : API_BASE;
			
			// Debug logging
			console.log('Current filters:', currentFilters);
			console.log('Request URL:', url);
			console.log('Query string:', queryString);
			
			const response = await fetch(url, {
				method: 'GET',
				headers: {
					'Authorization': `Bearer ${token}`,
					'Content-Type': 'application/json'
				},
				signal: signal
			});

			// Check if request was aborted
			if (signal.aborted) {
				return;
			}

			if (!response.ok) {
				if (response.status === 401) {
					localStorage.removeItem('access_token');
					window.location.href = '/login';
					return;
				}
				throw new Error(`HTTP error! status: ${response.status}`);
			}

			const customers = await response.json();
			
			// ========================================================================
			// FRONTEND DIAGNOSIS: Response verification
			// ========================================================================
			console.log("=".repeat(80));
			console.log("FRONTEND DIAGNOSIS - API Response");
			console.log("=".repeat(80));
			console.log(`Response status: ${response.status}`);
			console.log(`Response URL: ${response.url}`);
			console.log(`Response customers count: ${customers.length}`);
			if (customers.length > 0) {
				console.log("First customer sample:");
				console.log(`  ID: ${customers[0].id}`);
				console.log(`  Name: ${customers[0].full_name}`);
				console.log(`  Email: ${customers[0].email}`);
				console.log(`  Phone: ${customers[0].phone}`);
				
				// Verify if first result matches filter
				if (currentFilters.phone) {
					const firstPhone = customers[0].phone || '';
					if (!firstPhone.includes(currentFilters.phone)) {
						console.warn(`⚠️ WARNING: Filtered by phone '${currentFilters.phone}' but first result phone '${firstPhone}' doesn't contain it!`);
					} else {
						console.log(`✓ First result phone matches filter: ${firstPhone}`);
					}
				}
				if (currentFilters.name) {
					const firstName = customers[0].full_name || '';
					if (!firstName.toLowerCase().includes(currentFilters.name.toLowerCase())) {
						console.warn(`⚠️ WARNING: Filtered by name '${currentFilters.name}' but first result name '${firstName}' doesn't contain it!`);
					} else {
						console.log(`✓ First result name matches filter: ${firstName}`);
					}
				}
				if (currentFilters.email) {
					const firstEmail = customers[0].email || '';
					if (!firstEmail.toLowerCase().includes(currentFilters.email.toLowerCase())) {
						console.warn(`⚠️ WARNING: Filtered by email '${currentFilters.email}' but first result email '${firstEmail}' doesn't contain it!`);
					} else {
						console.log(`✓ First result email matches filter: ${firstEmail}`);
					}
				}
			} else {
				console.log("No customers in response (empty array)");
			}
			console.log("=".repeat(80));

			// Check again if request was aborted or if this is not the latest request
			if (signal.aborted || requestId !== currentRequestId) {
				console.log('Request aborted or superseded, ignoring response');
				return;
			}
			
			// Remove loading row
			if (loadingRow) {
				loadingRow.remove();
			}

			// Clear tbody
			tbody.innerHTML = '';

			// Final check before rendering (double-check race condition)
			if (signal.aborted || requestId !== currentRequestId) {
				console.log('Request aborted before rendering, ignoring response');
				return;
			}

			if (customers.length === 0) {
				// Destroy DataTable if exists - preserve page length
				if (datatable) {
					try {
						const pageInfo = datatable.page.info();
						currentPageLength = pageInfo.length;
					} catch (e) {
						// If page info is not available, keep current value
					}
					datatable.destroy();
					datatable = null;
				}
				
				// Clear tbody completely - let DataTables handle empty state
				tbody.innerHTML = '';
				// Initialize DataTable with empty data
				if (typeof $ !== 'undefined' && $.fn.DataTable && table) {
					datatable = $(table).DataTable({
						"info": false,
						"order": [],
						"pageLength": currentPageLength,
						"data": [], // Empty data array
						"columns": [
							null, // ID
							null, // Customer Name
							null, // Email
							null, // Phone
							null, // Created Date
							{"orderable": false} // Actions
						],
						"language": {
							"emptyTable": "No customers found",
							"zeroRecords": "No matching customers found"
						}
					});
					datatable.on('draw', function() {
						updateTableInfo();
					});
					// Listen for page length change to preserve it
					datatable.on('length.dt', function(e, settings, len) {
						currentPageLength = len;
					});
					updateTableInfo();
				}
				// Reinitialize Metronic menus after render
				if (typeof KTMenu !== 'undefined') {
					KTMenu.init();
				}
				return;
			}

			// Destroy DataTable BEFORE populating table (if it exists)
			// Preserve current page length before destroying
			if (datatable) {
				try {
					const pageInfo = datatable.page.info();
					currentPageLength = pageInfo.length; // Get current page length
				} catch (e) {
					// If page info is not available, keep current value
				}
				datatable.destroy();
				datatable = null;
			}

			// Clear tbody AFTER DataTable destroy (DataTable destroy may leave rows)
			tbody.innerHTML = '';

			// Populate table - prevent duplicate IDs
			const renderedIds = new Set();
			customers.forEach(customer => {
				// Skip if this customer ID was already rendered (duplicate prevention)
				if (renderedIds.has(customer.id)) {
					console.warn(`Duplicate customer ID detected: ${customer.id}, skipping`);
					return;
				}
				renderedIds.add(customer.id);

				// Final check before rendering this row
				if (signal.aborted || requestId !== currentRequestId) {
					console.log('Request aborted during row rendering, stopping');
					return;
				}

				const row = document.createElement('tr');
				const createdDate = new Date(customer.created_at);
				const formattedDate = createdDate.toLocaleDateString('en-US', {
					year: 'numeric',
					month: 'short',
					day: 'numeric',
					hour: '2-digit',
					minute: '2-digit'
				});

				row.innerHTML = `
					<td>
						<div class="text-gray-800 fw-bold">#${escapeHtml(customer.id)}</div>
					</td>
					<td>
						<a href="/customers/${customer.id}" class="text-gray-800 text-hover-primary mb-1">${escapeHtml(customer.full_name)}</a>
					</td>
					<td>
						<a href="mailto:${escapeHtml(customer.email)}" class="text-gray-600 text-hover-primary mb-1">${escapeHtml(customer.email)}</a>
					</td>
					<td>${escapeHtml(customer.phone || '-')}</td>
					<td>${formattedDate}</td>
					<td class="text-end">
						<a href="#" class="btn btn-sm btn-light btn-flex btn-center btn-active-light-primary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
							Actions 
							<i class="ki-duotone ki-down fs-5 ms-1">
								<span class="path1"></span>
								<span class="path2"></span>
							</i>
						</a>
						<!--begin::Menu-->
						<div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4" data-kt-menu="true">
							<!--begin::Menu item-->
							<div class="menu-item px-3">
								<a href="/customers/${customer.id}" class="menu-link px-3">View</a>
							</div>
							<!--end::Menu item-->
							<!--begin::Menu item-->
							<div class="menu-item px-3">
								<a href="/customers/${customer.id}/edit" class="menu-link px-3">Edit</a>
							</div>
							<!--end::Menu item-->
						</div>
						<!--end::Menu-->
					</td>
				`;
				tbody.appendChild(row);
			});

			// Final check before initializing DataTable
			if (signal.aborted || requestId !== currentRequestId) {
				console.log('Request aborted before DataTable init, ignoring');
				return;
			}

			// Initialize DataTable AFTER populating table
			if (typeof $ !== 'undefined' && $.fn.DataTable) {
				datatable = $(table).DataTable({
					"info": false, // We'll use custom info display
					"order": [],
					"pageLength": currentPageLength, // Use preserved page length
					"columns": [
						null, // ID
						null, // Customer Name
						null, // Email
						null, // Phone
						null, // Created Date
						{"orderable": false} // Actions
					],
					"language": {
						"emptyTable": "No customers found",
						"zeroRecords": "No matching customers found"
					}
				});

				// Update custom info display on draw and page change
				datatable.on('draw', function() {
					updateTableInfo();
				});

				// Listen for page length change to preserve it
				datatable.on('length.dt', function(e, settings, len) {
					currentPageLength = len;
				});

				// Initial update
				updateTableInfo();
			}

			// Reinitialize Metronic menus after table render is complete
			if (typeof KTMenu !== 'undefined') {
				KTMenu.init();
				// Also try createInstances if available
				if (typeof KTMenu.createInstances === 'function') {
					KTMenu.createInstances();
				}
			}

			// Log successful render for debugging
			console.log(`Customers rendered: ${customers.length} customers (request ID: ${requestId})`);

		} catch (error) {
			// Ignore abort errors
			if (error.name === 'AbortError') {
				return;
			}
			console.error('Error loading customers:', error);
			if (loadingRow) {
				loadingRow.innerHTML = `
					<td colspan="6" class="text-center py-10">
						<div class="text-danger">Error loading customers. Please try again.</div>
					</td>
				`;
			}
		} finally {
			// Clear abort controller if this was the current request
			if (currentAbortController && currentAbortController.signal === signal) {
				currentAbortController = null;
			}
		}
	}

	// Update table info display
	function updateTableInfo() {
		if (!datatable) return;
		
		const info = datatable.page.info();
		const infoElement = document.getElementById('kt_customers_table_info');
		
		if (infoElement) {
			const start = info.start + 1;
			const end = info.end;
			const total = info.recordsTotal;
			const filtered = info.recordsDisplay;
			
			if (filtered === 0) {
				infoElement.textContent = 'No customers found';
			} else {
				infoElement.textContent = `Showing ${start} to ${end} of ${filtered} entries${filtered !== total ? ` (filtered from ${total} total entries)` : ''}`;
			}
		}
	}

	// Configure toastr global settings
	if (typeof toastr !== 'undefined') {
		toastr.options = {
			"closeButton": true,
			"debug": false,
			"newestOnTop": true,
			"progressBar": true,
			"positionClass": "toast-top-right",
			"preventDuplicates": false,
			"showDuration": "300",
			"hideDuration": "1000",
			"timeOut": "5000",
			"extendedTimeOut": "1000",
			"showEasing": "swing",
			"hideEasing": "linear",
			"showMethod": "fadeIn",
			"hideMethod": "fadeOut"
		};
	}

	// Load customers on page load and setup event listeners
	document.addEventListener('DOMContentLoaded', function() {
		// Get table element
		table = document.querySelector('#kt_customers_table');
		
		if (!table) {
			console.warn('kt_customers_table element not found');
			return;
		}

		// Search functionality - use DataTable search
		const searchInput = document.getElementById('kt_customer_table_search');
		if (searchInput) {
			searchInput.addEventListener('keyup', function(e) {
				if (datatable) {
					datatable.search(e.target.value).draw();
					updateTableInfo();
				} else {
					// Fallback if DataTable not initialized yet
					const searchTerm = e.target.value.toLowerCase();
					const rows = document.querySelectorAll('#kt_customers_table_body tr');
					
					rows.forEach(row => {
						const text = row.textContent.toLowerCase();
						row.style.display = text.includes(searchTerm) ? '' : 'none';
					});
				}
			});
		} else {
			console.warn('kt_customer_table_search element not found');
		}

		// Apply filters button
		document.getElementById('btn_apply_filters')?.addEventListener('click', function() {
			const nameInput = document.getElementById('filter_name');
			const emailInput = document.getElementById('filter_email');
			const phoneInput = document.getElementById('filter_phone');
			
			currentFilters.name = nameInput?.value || null;
			currentFilters.email = emailInput?.value || null;
			currentFilters.phone = phoneInput?.value || null;
			
			console.log('Apply filters clicked');
			console.log('Filter inputs:', {
				name: nameInput?.value,
				email: emailInput?.value,
				phone: phoneInput?.value
			});
			console.log('Current filters after update:', currentFilters);
			
			loadCustomers();
		});

		// Reset filters button
		document.getElementById('btn_reset_filters')?.addEventListener('click', function() {
			currentFilters = {
				name: null,
				email: null,
				phone: null
			};
			document.getElementById('filter_name').value = '';
			document.getElementById('filter_email').value = '';
			document.getElementById('filter_phone').value = '';
			loadCustomers();
		});

		// Add customer form handler
		document.getElementById('kt_modal_add_customer_form')?.addEventListener('submit', async function(e) {
			e.preventDefault();
			
			const form = e.target;
			const submitButton = document.getElementById('kt_modal_add_customer_submit');
			const indicator = submitButton.querySelector('.indicator-label');
			const progress = submitButton.querySelector('.indicator-progress');
			
			// Show loading state
			submitButton.disabled = true;
			indicator.style.display = 'none';
			progress.style.display = 'inline-block';

			const formData = {
				full_name: form.full_name.value,
				email: form.email.value,
				phone: form.phone.value
			};

			try {
				const response = await fetch(API_BASE, {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${token}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(formData)
				});

				if (!response.ok) {
					if (response.status === 401) {
						localStorage.removeItem('access_token');
						window.location.href = '/login';
						return;
					}
					const errorData = await response.json();
					throw new Error(errorData.detail || 'Failed to create customer');
				}

				// Close modal
				const modalElement = document.getElementById('kt_modal_add_customer');
				if (modalElement) {
					const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
					modal.hide();
				}

				// Reset form
				form.reset();

				// Reload customers
				await loadCustomers();

				// Show success message
				if (typeof Swal !== 'undefined') {
					Swal.fire({
						text: "Customer added successfully!",
						icon: "success",
						buttonsStyling: false,
						confirmButtonText: "Ok",
						customClass: {
							confirmButton: "btn btn-primary"
						}
					});
				} else if (typeof toastr !== 'undefined') {
					toastr.success("Customer added successfully!");
				}

			} catch (error) {
				console.error('Error creating customer:', error);
				if (typeof Swal !== 'undefined') {
					Swal.fire({
						text: "Error: " + error.message,
						icon: "error",
						buttonsStyling: false,
						confirmButtonText: "Ok",
						customClass: {
							confirmButton: "btn btn-primary"
						}
					});
				} else if (typeof toastr !== 'undefined') {
					toastr.error("Error: " + error.message);
				} else {
					alert('Error: ' + error.message);
				}
			} finally {
				// Hide loading state
				submitButton.disabled = false;
				indicator.style.display = 'inline-block';
				progress.style.display = 'none';
			}
		});

		// Load customers on page load
		loadCustomers();
	});
</script>
{% endblock %}

