<!DOCTYPE html>
<!--
Author: Keenthemes
Product Name: MetronicProduct Version: 8.2.9
Purchase: https://1.envato.market/Vm7VRE
Website: http://www.keenthemes.com
Contact: support@keenthemes.com
Follow: www.twitter.com/keenthemes
Dribbble: www.dribbble.com/keenthemes
Like: www.facebook.com/keenthemes
License: For each use you must have a valid license purchased only from above link in order to legally use the theme for your project.
-->
<html lang="en">
	<!--begin::Head-->
	<head>
<!-- base href removed for FastAPI -->
		<title>Appointa</title>
		<meta charset="utf-8" />
		<meta name="description" content="The most advanced Tailwind CSS & Bootstrap 5 Admin Theme with 40 unique prebuilt layouts on Themeforest trusted by 100,000 beginners and professionals. Multi-demo, Dark Mode, RTL support and complete React, Angular, Vue, Asp.Net Core, Rails, Spring, Blazor, Django, Express.js, Node.js, Flask, Symfony & Laravel versions. Grab your copy now and get life-time updates for free." />
		<meta name="keywords" content="tailwind, tailwindcss, metronic, bootstrap, bootstrap 5, angular, VueJs, React, Asp.Net Core, Rails, Spring, Blazor, Django, Express.js, Node.js, Flask, Symfony & Laravel starter kits, admin themes, web design, figma, web development, free templates, free admin themes, bootstrap theme, bootstrap template, bootstrap dashboard, bootstrap dak mode, bootstrap button, bootstrap datepicker, bootstrap timepicker, fullcalendar, datatables, flaticon" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta property="og:locale" content="en_US" />
		<meta property="og:type" content="article" />
		<meta property="og:title" content="Metronic - The World's #1 Selling Tailwind CSS & Bootstrap Admin Template by KeenThemes" />
		<meta property="og:url" content="https://keenthemes.com/metronic" />
		<meta property="og:site_name" content="Metronic by Keenthemes" />
		<link rel="canonical" href="http://preview.keenthemes.comlayouts/light-sidebar.html" />
		<link rel="shortcut icon" href="/static/assets/logos/favicon.png" />
		<!--begin::Fonts(mandatory for all pages)-->
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700" />
		<!--end::Fonts-->
		<!--begin::Vendor Stylesheets(used for this page only)-->
		<link href="/static/plugins/custom/fullcalendar/fullcalendar.bundle.css" rel="stylesheet" type="text/css" />
		<link href="/static/plugins/custom/datatables/datatables.bundle.css" rel="stylesheet" type="text/css" />
		<!--end::Vendor Stylesheets-->
		<!--begin::Global Stylesheets Bundle(mandatory for all pages)-->
		<link href="/static/plugins/global/plugins.bundle.css" rel="stylesheet" type="text/css" />
		<link href="/static/css/style.bundle.css" rel="stylesheet" type="text/css" />
		<!--end::Global Stylesheets Bundle-->
		<script>// Frame-busting to prevent site from being loaded within a frame without permission (click-jacking) if (window.top != window.self) { window.top.location.replace(window.self.location.href); }</script>
	</head>
	<!--end::Head-->
	<!--begin::Body-->
	<body id="kt_app_body" data-kt-app-layout="light-sidebar" data-kt-app-header-fixed="true" data-kt-app-sidebar-enabled="true" data-kt-app-sidebar-fixed="true" data-kt-app-sidebar-hoverable="true" data-kt-app-sidebar-push-header="true" data-kt-app-sidebar-push-toolbar="true" data-kt-app-sidebar-push-footer="true" data-kt-app-toolbar-enabled="true" class="app-default">
		<!--begin::Theme mode setup on page load-->
		<script>var defaultThemeMode = "light"; var themeMode; if ( document.documentElement ) { if ( document.documentElement.hasAttribute("data-bs-theme-mode")) { themeMode = document.documentElement.getAttribute("data-bs-theme-mode"); } else { if ( localStorage.getItem("data-bs-theme") !== null ) { themeMode = localStorage.getItem("data-bs-theme"); } else { themeMode = defaultThemeMode; } } if (themeMode === "system") { themeMode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"; } document.documentElement.setAttribute("data-bs-theme", themeMode); }</script>
		<!--end::Theme mode setup on page load-->
		<!--begin::App-->
		<div class="d-flex flex-column flex-root app-root" id="kt_app_root">
			<!--begin::Page-->
			<div class="app-page flex-column flex-column-fluid" id="kt_app_page">
				{% include "partials/header.html" %}
				<!--begin::Wrapper-->
				<div class="app-wrapper flex-column flex-row-fluid" id="kt_app_wrapper">
					{% include "partials/sidebar.html" %}
					<!--begin::Main-->
					<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
						<!--begin::Content wrapper-->
						<div class="d-flex flex-column flex-column-fluid">
							<!--begin::Content-->
							<div id="kt_app_content" class="app-content flex-column-fluid">
								<!--begin::Content container-->
								<div id="kt_app_content_container" class="app-container container-fluid">
						{% block content %}
							<!-- Page content goes here -->
						{% endblock %}
								</div>
								<!--end::Content container-->
							</div>
							<!--end::Content-->
						</div>
						<!--end::Content wrapper-->
						<!--begin::Footer-->
					{% include "partials/footer.html" %}
						<!--end::Footer-->
					</div>
					<!--end:::Main-->
				</div>
				<!--end::Wrapper-->
			</div>
			<!--end::Page-->
		</div>
		<!--end::App-->
		<!--begin::Drawers-->
		<!--begin::Activities drawer-->
		<div id="kt_activities" class="bg-body" data-kt-drawer="true" data-kt-drawer-name="activities" data-kt-drawer-activate="true" data-kt-drawer-overlay="true" data-kt-drawer-width="{default:'300px', 'lg': '900px'}" data-kt-drawer-direction="end" data-kt-drawer-toggle="#kt_activities_toggle" data-kt-drawer-close="#kt_activities_close">
			<div class="card shadow-none border-0 rounded-0">
				
				<!--begin::Body-->
				<div class="card-body position-relative" id="kt_activities_body">
					<!--begin::Content-->
					<div id="kt_activities_scroll" class="position-relative scroll-y me-n5 pe-5" data-kt-scroll="true" data-kt-scroll-height="auto" data-kt-scroll-wrappers="#kt_activities_body" data-kt-scroll-dependencies="#kt_activities_header, #kt_activities_footer" data-kt-scroll-offset="5px">
						<!--begin::Timeline items-->
						<div class="timeline timeline-border-dashed" id="kt_activities_timeline">
							<!-- Timeline items will be dynamically loaded here -->
						</div>
						<!--end::Timeline items-->
					</div>
					<!--end::Content-->
				</div>
				<!--end::Body-->
			</div>
		</div>
		<!--end::Activities drawer-->
		<!--end::Drawers-->
		<!--begin::Scrolltop-->
		<div id="kt_scrolltop" class="scrolltop" data-kt-scrolltop="true">
			<i class="ki-outline ki-arrow-up"></i>
		</div>
		<!--end::Scrolltop-->
		<!--begin::Modals-->
		<!--end::Modals-->
		<!--begin::Javascript-->
		<script>var hostUrl = "/static/";</script>
		<!--begin::Global Javascript Bundle(mandatory for all pages)-->
		<script src="/static/plugins/global/plugins.bundle.js"></script>
		<script src="/static/js/scripts.bundle.js"></script>
		<!--end::Global Javascript Bundle-->
		<!--begin::Vendors Javascript(used for this page only)-->
		<script src="/static/plugins/custom/fullcalendar/fullcalendar.bundle.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/geodata/continentsLow.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/geodata/usaLow.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/geodata/worldTimeZonesLow.js"></script>
		<script src="https://cdn.amcharts.com/lib/5/geodata/worldTimeZoneAreasLow.js"></script>
		<script src="/static/plugins/custom/datatables/datatables.bundle.js"></script>
		<!--end::Vendors Javascript-->
		<!--begin::Custom Javascript(used for this page only)-->
		<script src="/static/js/widgets.bundle.js"></script>
		<script src="/static/js/custom/widgets.js"></script>
		<script src="/static/js/custom/apps/chat/chat.js"></script>
		<script src="/static/js/custom/utilities/modals/upgrade-plan.js"></script>
		<script src="/static/js/custom/utilities/modals/create-app.js"></script>
		<script src="/static/js/custom/utilities/modals/users-search.js"></script>
		<!--end::Custom Javascript-->
		<!--begin::Load User Info-->
		<script>
			// Load current user information
			async function loadUserInfo() {
				const token = localStorage.getItem('access_token');
				if (!token) {
					// No token, redirect to login
					window.location.href = '/login';
					return;
				}

				try {
					const response = await fetch('/api/auth/me', {
						method: 'GET',
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						}
					});

					if (response.status === 401) {
						// Token invalid, redirect to login
						localStorage.removeItem('access_token');
						window.location.href = '/login';
						return;
					}

					if (!response.ok) {
						console.error('Failed to load user info');
						return;
					}

					const user = await response.json();
					
					// Update header user info
					const userNameElement = document.getElementById('header-user-name');
					const userEmailElement = document.getElementById('header-user-email');
					
					if (userNameElement) {
						userNameElement.innerHTML = user.full_name || 'User';
						if (user.role === 'owner') {
							userNameElement.innerHTML += '<span class="badge badge-light-success fw-bold fs-8 px-2 py-1 ms-2">Owner</span>';
						}
					}
					
					if (userEmailElement) {
						userEmailElement.textContent = user.email || '';
					}
					
					// Store user role globally
					currentUserRole = user.role;
					currentUserId = user.id;
					
					// Update menu visibility based on role
					updateMenuVisibility(user.role);
				} catch (error) {
					console.error('Error loading user info:', error);
				}
			}

			// Update menu visibility based on role
			function updateMenuVisibility(role) {
				// Users menu - only for owner (admin cannot access)
				const usersMenuItem = document.getElementById('users_menu_item');
				if (usersMenuItem) {
					usersMenuItem.style.display = (role === 'owner') ? 'block' : 'none';
				}
				
				// Staff heading - hidden for staff role
				const staffHeadingItem = document.getElementById('staff_heading_item');
				if (staffHeadingItem) {
					staffHeadingItem.style.display = (role === 'staff') ? 'none' : 'block';
				}
				
				// Staff menu - hidden for staff role
				const staffMenuItem = document.getElementById('staff_menu_item');
				if (staffMenuItem) {
					staffMenuItem.style.display = (role === 'staff') ? 'none' : 'block';
				}
				
				// Booking heading - hidden for staff role
				const bookingHeadingItem = document.getElementById('booking_heading_item');
				if (bookingHeadingItem) {
					bookingHeadingItem.style.display = (role === 'staff') ? 'none' : 'block';
				}
				
				// Booking menu - hidden for staff role
				const bookingMenuItem = document.getElementById('booking_menu_item');
				if (bookingMenuItem) {
					bookingMenuItem.style.display = (role === 'staff') ? 'none' : 'block';
				}
				
				// Settings menu - hidden for staff role
				const settingsMenuItem = document.getElementById('settings_menu_item');
				if (settingsMenuItem) {
					settingsMenuItem.style.display = (role === 'staff') ? 'none' : 'block';
				}
				
				// Customers menu - visible for all, but create link hidden for staff
				const customersCreateMenuItem = document.getElementById('customers_create_menu_item');
				if (customersCreateMenuItem) {
					customersCreateMenuItem.style.display = (role === 'staff') ? 'none' : 'block';
				}
				
				// Services menu - visible for all, but create link hidden for staff
				const servicesCreateMenuItem = document.getElementById('services_create_menu_item');
				if (servicesCreateMenuItem) {
					servicesCreateMenuItem.style.display = (role === 'staff') ? 'none' : 'block';
				}
				
				// Appointments menu - change title for staff
				const appointmentsMenuTitle = document.getElementById('appointments_menu_title');
				if (appointmentsMenuTitle) {
					appointmentsMenuTitle.textContent = (role === 'staff') ? 'My Appointments' : 'Appointments';
				}
			}

			// Load user info when page loads
			document.addEventListener('DOMContentLoaded', loadUserInfo);
		</script>
		<!--end::Load User Info-->
		<!--begin::Load Activities-->
		<script>
			let currentUserRole = null;
			let currentUserId = null;

			// Status badge class mapping
			const statusBadgeClasses = {
				'scheduled': 'badge-light-primary',
				'completed': 'badge-light-success',
				'cancelled': 'badge-light-danger',
				'no_show': 'badge-light-warning'
			};

			const statusLabels = {
				'scheduled': 'Scheduled',
				'completed': 'Completed',
				'cancelled': 'Cancelled',
				'no_show': 'No Show'
			};

			// Format date and time
			function formatDateTime(dateTimeString) {
				const date = new Date(dateTimeString);
				const options = { 
					year: 'numeric', 
					month: 'short', 
					day: 'numeric',
					hour: '2-digit',
					minute: '2-digit'
				};
				return date.toLocaleDateString('en-US', options);
			}

			function formatTime(dateTimeString) {
				const date = new Date(dateTimeString);
				return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
			}

			// Load activities
			async function loadActivities() {
				const token = localStorage.getItem('access_token');
				if (!token) {
					return;
				}

				try {
					const response = await fetch('/api/appointments/activities?limit=10', {
						method: 'GET',
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						}
					});

					if (response.status === 401) {
						return;
					}

					if (!response.ok) {
						console.error('Failed to load activities');
						return;
					}

					const appointments = await response.json();
					const timelineContainer = document.getElementById('kt_activities_timeline');
					
					if (!timelineContainer) {
						return;
					}

					// Clear existing content
					timelineContainer.innerHTML = '';

					if (appointments.length === 0) {
						timelineContainer.innerHTML = '<div class="text-center py-10"><p class="text-muted">No appointments found</p></div>';
						return;
					}

					// Render appointments based on user role
					appointments.forEach((appointment, index) => {
						const isLast = index === appointments.length - 1;
						const servicesList = appointment.services && appointment.services.length > 0
							? appointment.services.map(s => s.name).join(', ')
							: 'No services';
						
						const statusClass = statusBadgeClasses[appointment.status] || 'badge-light';
						const statusLabel = statusLabels[appointment.status] || appointment.status;

						let timelineItemHTML = '';

						if (currentUserRole === 'staff') {
							// Staff view: Show customer name and services
							timelineItemHTML = `
								<div class="timeline-item">
									<div class="timeline-line"></div>
									<div class="timeline-icon">
										<i class="ki-outline ki-message-text-2 fs-2 text-gray-500"></i>
									</div>
									<div class="timeline-content ${isLast ? 'mt-n1' : 'mb-10 mt-n1'}">
										<div class="pe-3 mb-5">
											<div class="fs-5 fw-semibold mb-2">${servicesList}</div>
											<div class="d-flex align-items-center mt-1 fs-6">
												<div class="text-muted me-2 fs-7">${formatTime(appointment.appointment_date)}</div>
											</div>
										</div>
										<div class="overflow-auto pb-5">
											<div class="d-flex align-items-center border border-dashed border-gray-300 rounded min-w-750px px-7 py-3 mb-5">
												<div class="fs-5 text-gray-900 text-hover-primary fw-semibold w-375px min-w-200px">${servicesList}</div>
												<div class="min-w-175px pe-2">
													<span class="badge badge-light text-muted">${appointment.customer_full_name || 'Unknown'}</span>
												</div>
												<div class="min-w-125px pe-2">
													<span class="badge ${statusClass}">${statusLabel}</span>
												</div>
												<a href="/appointments/${appointment.id}" class="btn btn-sm btn-light btn-active-light-primary">View</a>
											</div>
										</div>
									</div>
								</div>
							`;
						} else {
							// Admin/Owner view: Show appointment ID, staff name, and status
							timelineItemHTML = `
								<div class="timeline-item">
									<div class="timeline-line"></div>
									<div class="timeline-icon">
										<i class="ki-outline ki-basket fs-2 text-gray-500"></i>
									</div>
									<div class="timeline-content ${isLast ? 'mt-n1' : 'mb-10 mt-n1'}">
										<div class="pe-3 mb-5">
											<div class="fs-5 fw-semibold mb-2">New Appointment
												<a href="/appointments/${appointment.id}" class="text-primary fw-bold me-1">#${appointment.id}</a>
											</div>
											<div class="d-flex align-items-center mt-1 fs-6">
												<div class="text-muted me-2 fs-7">${formatDateTime(appointment.appointment_date)}</div>
												<span class="text-muted me-2">by</span>
												<a href="#" class="text-primary fw-bold me-1">${appointment.staff_full_name || 'Unknown Staff'}</a>
												<div class="pe-2">
													<span class="badge ${statusClass}">${statusLabel}</span>
												</div>
											</div>
										</div>
									</div>
								</div>
							`;
						}

						timelineContainer.innerHTML += timelineItemHTML;
					});
				} catch (error) {
					console.error('Error loading activities:', error);
				}
			}

			// Load activities when user info is loaded
			async function loadActivitiesAfterUserInfo() {
				const token = localStorage.getItem('access_token');
				if (!token) {
					return;
				}

				try {
					const response = await fetch('/api/auth/me', {
						method: 'GET',
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						}
					});

					if (response.ok) {
						const user = await response.json();
						currentUserRole = user.role;
						currentUserId = user.id;
						loadActivities();
					}
				} catch (error) {
					console.error('Error loading user info for activities:', error);
				}
			}

			// Load activities when page loads
			document.addEventListener('DOMContentLoaded', loadActivitiesAfterUserInfo);
		</script>
		<!--end::Load Activities-->
		{% block scripts %}{% endblock %}
		<!--end::Javascript-->
	</body>
	<!--end::Body-->
</html>