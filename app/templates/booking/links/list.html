{% extends "base.html" %}

{% block content %}
<!--begin::Content container-->
<div id="kt_app_content_container" class="app-container container-xxl">
	<!--begin::Card-->
	<div class="card">
		<!--begin::Card header-->
		<div class="card-header border-0 pt-6">
			<!--begin::Card title-->
			<div class="card-title">
				<h2 class="fw-bold">Booking Links</h2>
			</div>
			<!--end::Card title-->
			<!--begin::Card toolbar-->
			<div class="card-toolbar">
				<!--begin::Add booking link-->
				<a href="/booking-links/create" class="btn btn-primary">
					<i class="ki-duotone ki-plus fs-2"></i>Create Booking Link
				</a>
				<!--end::Add booking link-->
			</div>
			<!--end::Card toolbar-->
		</div>
		<!--end::Card header-->
		<!--begin::Card body-->
		<div class="card-body pt-0">
			<!--begin::Table-->
			<table class="table align-middle table-row-dashed fs-6 gy-5" id="kt_booking_links_table">
				<thead>
					<tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
						<th class="min-w-80px">ID</th>
						<th class="min-w-150px">Name</th>
						<th class="min-w-150px">Services</th>
						<th class="min-w-150px">Staff</th>
						<th class="min-w-120px">Range</th>
						<th class="text-end min-w-100px">Actions</th>
					</tr>
				</thead>
				<tbody class="fw-semibold text-gray-600" id="kt_booking_links_table_body">
					<!-- Data will be loaded here via JavaScript -->
					<tr id="kt_booking_links_table_loading">
						<td colspan="6" class="text-center py-10">
							<div class="spinner-border text-primary" role="status">
								<span class="visually-hidden">Loading...</span>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
			<!--end::Table-->
		</div>
		<!--end::Card body-->
	</div>
	<!--end::Card-->
	<!--begin::Table Info (outside card)-->
	<div class="d-flex align-items-center justify-content-between flex-wrap mt-5">
		<div class="text-gray-600 fw-semibold fs-6" id="kt_booking_links_table_info">
			<!-- DataTable info will be displayed here -->
		</div>
	</div>
	<!--end::Table Info-->
</div>
<!--end::Content container-->
{% endblock %}

{% block scripts %}
<script>
	"use strict";

	// Token kontrol√º
	const token = localStorage.getItem('access_token');
	if (!token) {
		window.location.href = '/login';
	}

	// API base URL
	const API_BASE = '/api/booking-links';

	// Race condition guard
	let currentAbortController = null;
	let currentRequestId = 0;

	// DataTable instance
	let datatable = null;
	let table = null;
	let currentPageLength = 10;

	// Escape HTML to prevent XSS
	function escapeHtml(text) {
		const str = String(text || '');
		if (!str) return '';
		const map = {
			'&': '&amp;',
			'<': '&lt;',
			'>': '&gt;',
			'"': '&quot;',
			"'": '&#039;'
		};
		return str.replace(/[&<>"']/g, m => map[m]);
	}


	// Load booking links
	async function loadBookingLinks() {
		if (currentAbortController) {
			currentAbortController.abort();
		}

		currentAbortController = new AbortController();
		const signal = currentAbortController.signal;
		const requestId = ++currentRequestId;

		const tbody = document.getElementById('kt_booking_links_table_body');
		const loadingRow = document.getElementById('kt_booking_links_table_loading');
		
		if (!tbody) return;

		try {
			const response = await fetch(API_BASE, {
				method: 'GET',
				headers: {
					'Authorization': `Bearer ${token}`,
					'Content-Type': 'application/json'
				},
				signal: signal
			});

			if (signal.aborted) return;

			if (!response.ok) {
				if (response.status === 401) {
					localStorage.removeItem('access_token');
					window.location.href = '/login';
					return;
				}
				throw new Error(`HTTP error! status: ${response.status}`);
			}

			const bookingLinks = await response.json();

			if (signal.aborted || requestId !== currentRequestId) return;
			
			if (loadingRow) loadingRow.remove();

			if (datatable) {
				try {
					currentPageLength = datatable.page.info().length;
				} catch (e) {}
				datatable.destroy();
				datatable = null;
			}

			tbody.innerHTML = '';

			if (signal.aborted || requestId !== currentRequestId) return;

			if (bookingLinks.length === 0) {
				// Clear tbody completely - let DataTables handle empty state
				tbody.innerHTML = '';
				if (typeof $ !== 'undefined' && $.fn.DataTable && table) {
					datatable = $(table).DataTable({
						"info": false,
						"order": [],
						"pageLength": currentPageLength,
						"data": [], // Empty data array
						"columns": [
							null, // ID
							null, // Name
							null, // Services
							null, // Staff
							null, // Range
							{"orderable": false} // Actions
						],
						"language": {
							"emptyTable": "No booking links found",
							"zeroRecords": "No matching booking links found"
						}
					});
					datatable.on('draw', updateTableInfo);
					datatable.on('length.dt', (e, settings, len) => { currentPageLength = len; });
					updateTableInfo();
				}
				return;
			}

			const renderedIds = new Set();
			bookingLinks.forEach(link => {
				if (renderedIds.has(link.id)) return;
				renderedIds.add(link.id);

				if (signal.aborted || requestId !== currentRequestId) return;

				const row = document.createElement('tr');
				const publicUrl = `${window.location.origin}/public/booking/${link.token}`;
				
				// Services display
				let servicesDisplay = 'All Services';
				if (link.service_ids && link.service_ids.length > 0) {
					servicesDisplay = `${link.service_ids.length} service(s)`;
				}

				// Staff display
				let staffDisplay = 'All Staff';
				if (link.staff_ids && link.staff_ids.length > 0) {
					staffDisplay = `${link.staff_ids.length} staff`;
				}

				// Date range display
				let dateRangeDisplay = 'No limit';
				if (link.start_date || link.end_date) {
					const start = link.start_date ? new Date(link.start_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Any';
					const end = link.end_date ? new Date(link.end_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Any';
					dateRangeDisplay = `${start} - ${end}`;
				}

				row.innerHTML = `
					<td>
						<div class="text-gray-800 fw-bold">#${escapeHtml(link.id)}</div>
					</td>
					<td>${escapeHtml(link.name)}</td>
					<td>${escapeHtml(servicesDisplay)}</td>
					<td>${escapeHtml(staffDisplay)}</td>
					<td>${escapeHtml(dateRangeDisplay)}</td>
					<td class="text-end">
						<a href="${escapeHtml(publicUrl)}" target="_blank" class="btn btn-sm btn-primary me-2">
							<i class="ki-duotone ki-arrow-right fs-5">
								<span class="path1"></span>
								<span class="path2"></span>
							</i>
							URL
						</a>
						<a href="#" class="btn btn-sm btn-light btn-flex btn-center btn-active-light-primary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
							Actions 
							<i class="ki-duotone ki-down fs-5 ms-1">
								<span class="path1"></span>
								<span class="path2"></span>
							</i>
						</a>
						<!--begin::Menu-->
						<div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4" data-kt-menu="true">
							<!--begin::Menu item-->
							<div class="menu-item px-3">
								<a href="/booking-links/${link.id}/edit" class="menu-link px-3">Edit</a>
							</div>
							<!--end::Menu item-->
							<!--begin::Menu item-->
							<div class="menu-item px-3">
								<a href="#" class="menu-link px-3 text-danger" onclick="deleteBookingLink(${link.id}); return false;">Delete</a>
							</div>
							<!--end::Menu item-->
						</div>
						<!--end::Menu-->
					</td>
				`;
				tbody.appendChild(row);
			});

			if (signal.aborted || requestId !== currentRequestId) return;

			if (typeof $ !== 'undefined' && $.fn.DataTable) {
				datatable = $(table).DataTable({
					"info": false,
					"order": [],
					"pageLength": currentPageLength,
					"columns": [
						null, // ID
						null, // Name
						null, // Services
						null, // Staff
						null, // Range
						{"orderable": false} // Actions
					],
					"language": {
						"emptyTable": "No booking links found",
						"zeroRecords": "No matching booking links found"
					}
				});

				datatable.on('draw', updateTableInfo);
				datatable.on('length.dt', (e, settings, len) => { currentPageLength = len; });
				updateTableInfo();
			}

			if (typeof KTMenu !== 'undefined') {
				KTMenu.init();
			}

		} catch (error) {
			if (error.name === 'AbortError') return;
			console.error('Error loading booking links:', error);
			if (loadingRow) {
				loadingRow.innerHTML = `
					<td colspan="6" class="text-center py-10">
						<div class="text-danger">Error loading booking links. Please try again.</div>
					</td>
				`;
			}
		} finally {
			if (currentAbortController && currentAbortController.signal === signal) {
				currentAbortController = null;
			}
		}
	}

	// Update table info
	function updateTableInfo() {
		if (!datatable) return;
		const info = datatable.page.info();
		const infoElement = document.getElementById('kt_booking_links_table_info');
		if (infoElement) {
			const start = info.start + 1;
			const end = info.end;
			const total = info.recordsTotal;
			const filtered = info.recordsDisplay;
			if (filtered === 0) {
				infoElement.textContent = 'No booking links found';
			} else {
				infoElement.textContent = `Showing ${start} to ${end} of ${filtered} entries${filtered !== total ? ` (filtered from ${total} total entries)` : ''}`;
			}
		}
	}

	// Delete booking link
	async function deleteBookingLink(linkId) {
		if (typeof Swal === 'undefined') {
			if (!confirm('Are you sure you want to delete this booking link?')) return;
		} else {
			const result = await Swal.fire({
				text: "Are you sure you want to delete this booking link?",
				icon: "warning",
				showCancelButton: true,
				buttonsStyling: false,
				confirmButtonText: "Yes, delete!",
				cancelButtonText: "No, cancel",
				customClass: {
					confirmButton: "btn btn-danger",
					cancelButton: "btn btn-light"
				}
			});
			if (!result.isConfirmed) return;
		}

		try {
			const response = await fetch(`${API_BASE}/${linkId}`, {
				method: 'DELETE',
				headers: {
					'Authorization': `Bearer ${token}`,
					'Content-Type': 'application/json'
				}
			});

			if (!response.ok) {
				if (response.status === 401) {
					localStorage.removeItem('access_token');
					window.location.href = '/login';
					return;
				}
				const errorData = await response.json();
				throw new Error(errorData.detail || 'Failed to delete booking link');
			}

			if (typeof Swal !== 'undefined') {
				Swal.fire({
					text: "Booking link deleted successfully!",
					icon: "success",
					buttonsStyling: false,
					confirmButtonText: "Ok",
					customClass: {
						confirmButton: "btn btn-primary"
					}
				});
			}

			loadBookingLinks();
		} catch (error) {
			console.error('Error deleting booking link:', error);
			if (typeof Swal !== 'undefined') {
				Swal.fire({
					text: "Error: " + error.message,
					icon: "error",
					buttonsStyling: false,
					confirmButtonText: "Ok",
					customClass: {
						confirmButton: "btn btn-primary"
					}
				});
			}
		}
	}

	// Configure toastr
	if (typeof toastr !== 'undefined') {
		toastr.options = {
			"closeButton": true,
			"debug": false,
			"newestOnTop": true,
			"progressBar": false,
			"positionClass": "toast-top-right",
			"preventDuplicates": false,
			"onclick": null,
			"showDuration": "300",
			"hideDuration": "1000",
			"timeOut": "5000",
			"extendedTimeOut": "1000",
			"showEasing": "swing",
			"hideEasing": "linear",
			"showMethod": "fadeIn",
			"hideMethod": "fadeOut"
		};
	}

	// Load on page load
	document.addEventListener('DOMContentLoaded', function() {
		table = document.getElementById('kt_booking_links_table');
		if (!table) {
			console.error('kt_booking_links_table element not found');
			return;
		}
		loadBookingLinks();
	});
</script>
{% endblock %}
